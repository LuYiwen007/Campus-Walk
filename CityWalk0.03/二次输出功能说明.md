# CityWalk 二次输出功能实现说明

## 功能概述

本功能实现了AI智能体的二次输出模式：
1. **第一阶段**：AI内部调用高德地图服务，获取地点信息（不显示给用户）
2. **第二阶段**：基于地点信息生成3条完整路线，显示给用户
3. **分段导航**：用户可以选择查看分段路线，在地图上逐段显示

## 实现架构

### 后端 (Python FastAPI)

#### 新增数据库表
- `RouteLocations`: 存储AI返回的地点信息
  - `conversation_id`: 关联的会话ID
  - `locations`: 地点名称，用"--"分隔
  - `route_type`: 路线类型（walking/driving等）

#### 新增API接口
- `POST /route-locations/save.json`: 保存地点信息
- `GET /route-locations/get.json`: 获取地点信息
- `POST /route-segments/get.json`: 获取分段路线数据

### 前端 (Swift iOS)

#### QianwenService 修改
- 添加二次输出处理逻辑
- 自动提取地点信息并保存到后端
- 只向用户显示第二阶段的完整路线

#### MessageViewModel 修改
- 添加分段路线显示控制
- 自动检测路线推荐并提示用户查看分段导航

#### 新增 SegmentedRouteView
- 分段路线显示界面
- 支持逐段查看路线
- 集成地图显示功能

## 使用流程

1. **用户输入路线需求** → 前端发送到后端
2. **后端调用通义千问** → AI返回地点信息（第一阶段，不显示）
3. **地点信息保存** → 存储到RouteLocations表
4. **AI生成完整路线** → 返回3条路线推荐（第二阶段，显示给用户）
5. **用户查看分段导航** → 可选择查看逐段路线

## 配置要求

### 百炼控制台配置
使用提供的完整提示词，确保AI按二次输出模式工作：

```json
{
  "role": "citywalk_route_planner",
  "description": "专业的城市漫步路线规划专家，采用内部二次处理模式：内部调用高德地图获取数据，最终输出3条完整路线给用户",
  "output_mode": "internal_two_stage",
  "stage1": {
    "purpose": "内部数据获取",
    "user_visibility": false
  },
  "stage2": {
    "purpose": "用户可见输出",
    "user_visibility": true,
    "route_count": 3
  }
}
```

### 高德地图API配置
- 需要在后端配置高德地图API Key
- 支持步行路线规划API
- 支持POI搜索API

## 技术特点

1. **无缝用户体验**：用户只看到最终结果，不知道内部处理过程
2. **数据完整性**：两个阶段的数据都完整保存
3. **分段导航**：支持逐段查看路线，便于导航
4. **错误处理**：完善的错误处理和用户提示
5. **兼容性**：保持与现有功能的兼容

## 注意事项

1. 确保高德地图API Key有效且有足够配额
2. 网络连接稳定，确保前后端通信正常
3. 数据库表会自动创建，无需手动操作
4. 分段路线功能需要用户主动触发

## 测试建议

1. 测试完整的二次输出流程
2. 测试分段路线显示功能
3. 测试地图集成和路线绘制
4. 测试错误处理和异常情况
5. 测试不同网络环境下的表现
